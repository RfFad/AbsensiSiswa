<%- include("../Componen/header") %>
<title>Guru | Tugas</title>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<%- include("../Componen/sidebar") %>

<div class="content-wrapper">
    <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            
          </div>
          
        </div>
      </div>
    
        <section class="content">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h4>Data Tugas</h4>
                            </div>
                            <div class="card-body">
                                <div class="d-flex flex-column flex-md-row justify-content-between mb-2">
                                    <div class="btn-group w-100 flex-md-row mb-2 mb-md-0" id="btn-tambah">
                                      <span class="btn btn-success col-12 col-md-3 fileinput-button mb-2 mb-md-0">
                                        <i class="fas fa-plus"></i>
                                        <span>Tambahkan data</span>
                                      </span>
                                    </div>
                                  
                                    <div class="d-flex justify-content-end">
                                      <input type="text" class="form-control" name="table_search" style="width: 160px;">
                                      <button type="submit" class="btn btn-secondary ml-2">Search</button>
                                    </div>
                                  </div>
                                <div class="table-responsive">
                                    <ul class="nav nav-tabs nav-tugas-container" id="myTab" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link nav-tugas active" id="mulai-tab" data-bs-toggle="tab" data-bs-target="#mulai" type="button" role="tab" aria-controls="mulai" aria-selected="true">Tugas aktif</button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link nav-tugas" id="selesai-tab" data-bs-toggle="tab" data-bs-target="#selesai" type="button" role="tab" aria-controls="selesai" aria-selected="false">Tugas Selesai</button>
                                        </li>
                                    </ul>
                                    <div class="tab-content mt-3" id="myTabContent">
                                    <div class="tab-pane fade show active" id="mulai" role="tabpanel" aria-labelledby="mulai-tab">
                                        
                                            <div class="aktif">
                                                <!-- Konten tabel akan dimuat di sini -->
                                            </div>
                                        
                                    </div>
                                    <div class="tab-pane fade" id="selesai" role="tabpanel" aria-labelledby="selesai-tab">
                                        <div class="selesai">
                                            
                                        </div>
                                    </div>
                                </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
</div>
        <!-- Modal Tambah -->
        <div class="modal fade" id="modal-tambah">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title">Penambahan Data</h4>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="main-body">
                            <form id="tugasForm" enctype="multipart/form-data">
                                <input type="hidden" name="id_guru" value="<%= rows.id_guru %>">
                                <input type="hidden" name="id_tugas"  value="">
                                <input type="hidden" name="id_mapel" value="<%= rows.idm %>">
                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="form-group">
                                        <label for="">Judul Tugas : </label>
                                        <input type="text" class="form-control" id="judul_tugas" name="judul_tugas" placeholder="Judul Tugas">
                                    </div>
                                    <label for="">Tanggal Mulai : </label>
                                    <div class="input-group mb-3">
                                        <div class="input-group-prepend">
                                          <span class="input-group-text"><i class="far fa-calendar-alt"></i></span>
                                        </div>
                                        <input type="date" name="tanggal_diberikan" class="form-control" data-inputmask-alias="datetime" data-inputmask-inputformat="dd/mm/yyyy" data-mask>
                                      </div>
                                    <div class="form-group">
                                        <label for="">Deskripsi</label>
                                        <textarea name="deskripsi" class="form-control" id=""></textarea>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="form-group">
                                        <label for="">Kelas :</label>
                                        <select class="form-control" name="id_kelas" id="">
                                            <% kelas.forEach(k => { %>
                                           <option value="<%= k.id_kelas %>"><%= k.nama_kelas %></option>
                                           <% }) %>
                                          </select>
                                    </div>
                                    <label for="">Tanggal Deadline</label>
                                    <div class="input-group mb-3">
                                        <div class="input-group-prepend">
                                          <span class="input-group-text"><i class="far fa-calendar-alt"></i></span>
                                        </div>
                                        <input type="date" name="tanggal_deadline" class="form-control" data-inputmask-alias="datetime" data-inputmask-inputformat="dd/mm/yyyy" data-mask>
                                      </div>
                                    <div class="form-group">
                                        <label for="">Waktu Deadline</label>
                                        <input type="time" class="form-control" name="waktu_deadline">
                                    </div>
                                    <div class="form-group">
                                        <label for="">File/Foto Tugas(Opsional)</label>
                                        <input type="file" name="file_tugas" class="form-control">
                                    </div>
                                    <div class="form-group">
                                        <label for="">Status</label>
                                        <select name="status" class="form-control" id="">
                                            <option value="aktif">Aktif</option>
                                            <option value="aktif">Selesai</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </form>
                        </div>
                    </div>
                    <div class="modal-footer d-flex justify-content-between">
                        <div>
                          <button type="button" class="btn btn-secondary close">Close</button>
                        </div>
                        <div>
                          <button type="submit" form="tugasForm" class="btn btn-primary">
                            Simpan
                          </button>
                        </div>
                      </div>
                </div>
            </div>
        </div>
        
    

    <!-- Skrip dari AdminLTE dan Bootstrap -->
    <script src="/plugins/jquery/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Kode yang lain tetap sama -->

<script>
    $(document).ready(function() {
        // Menampilkan data tugas

        list();
       
        // Tutup modal saat tombol close ditekan
        $(".close").on('click', function(){
            $("#modal-tambah").modal("hide");
        });

        // Tampilkan modal tambah data
        $("#btn-tambah").on('click', function() {
            $("#tugasForm")[0].reset();  // Reset form saat tambah data baru
            $("#modal-tambah").modal("show");
        });
        function Hari(tanggal) {
                const hariNama = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
                return hariNama[tanggal];
            }
        // Fungsi untuk memuat daftar tugas
        function list() {
            let htmlAktif = "";
            let htmlSelesai = "";
            $.ajax({
                url: "/guru/data_tugas",
                type: "GET",
                success: function(result) {
                    if (result.count > 0) {
                        const val = result.data;

                        const dataAktif = val.filter(row => row.status === "aktif");
                        const dataSelesai = val.filter(row => row.status === "selesai");

                        if(dataAktif.length > 0){
                        htmlAktif += "<table class='table table-bordered table-striped table-hover'>";
                        htmlAktif += "<thead class='bg-dark'>";
                        htmlAktif += "<tr>"
                        htmlAktif += "<th style='width: 1%;'>No</th>";
                        htmlAktif += "<th>Kelas</th>";
                        htmlAktif += "<th>Judul Tugas</th>";
                        htmlAktif += "<th>Mapel</th>";
                        htmlAktif += "<th>Diberikan</th>";
                        htmlAktif += "<th>Deadline</th>";
                        htmlAktif += "<th>Action</th>";
                        htmlAktif += "</tr>";
                        htmlAktif += "</thead><tbody>";
                        $.each(dataAktif, function(index, row) {
                            const tanggalDiberikan = new Date(row.tanggal_diberikan);
                            const tanggalDeadline = new Date(row.tanggal_deadline);
                            const hariDiberikan = Hari(tanggalDiberikan.getDay());
                            const hariDeadline = Hari(tanggalDeadline.getDay());
                            const formatDiberikan = tanggalDiberikan.toLocaleDateString('id-ID').split('/').join('-');
                            const formatDeadline = tanggalDeadline.toLocaleDateString('id-ID').split('/').join('-');
                            
                            htmlAktif += `<tr id='data' kode='${row.id_tugas}'>`;
                            htmlAktif += `<td>${index + 1}</td>`;
                            htmlAktif += `<td>${row.nama_kelas}</td>`;
                            htmlAktif += `<td>${row.judul_tugas}</td>`;
                            htmlAktif += `<td>${row.nama_mp}</td>`;
                            htmlAktif += `<td><label class='label bg-success' style="border-radius: 6px; width: 200px; text-align: center;" id="tanggalMulai"> ${hariDiberikan}, ${formatDiberikan}</label>
                               </td>`;
                            htmlAktif += `<td> <label class='label bg-danger' style="border-radius: 6px; width: 200px; text-align: center;" id="tanggalMulai">${hariDeadline}, ${formatDeadline} ${row.waktu_deadline.slice(0, 5)}`;
                            htmlAktif += `<td>
                                <button class='btn btn-warning' id='btn-edit' data-id='${row.id_tugas}'>Edit</button>
                                <button class='btn btn-danger btn-hapus' data-tugas ='${row.id_tugas}'>Hapus</button>
                                <a href='/guru/tugas_detail/${row.id_tugas}' class='btn btn-primary'>Detail</a>
                                </td>`;
                            htmlAktif += "</tr>";
                        });
                        htmlAktif += "</tbody></table>";
                    }else{
                        htmlAktif += "<p>No data available with status 'aktif'</p>";
                    }
                        if(dataSelesai.length > 0){
                        htmlSelesai += "<table class='table table-bordered table-striped table-hover'>";
                        htmlSelesai += "<thead class='bg-dark'>";
                        htmlSelesai += "<tr>"
                        htmlSelesai += "<th style='width: 1%;'>No</th>";
                        htmlSelesai += "<th>Kelas</th>";
                        htmlSelesai += "<th>Judul Tugas</th>";
                        htmlSelesai += "<th>Mapel</th>";
                        htmlSelesai += "<th>Diberikan</th>";
                        htmlSelesai += "<th>Deadline</th>";
                        htmlSelesai += "<th>Action</th>";
                        htmlSelesai += "</tr>";
                        htmlSelesai += "</thead><tbody>";
                        $.each(dataSelesai, function(index, row) {
                            const tanggalDiberikan = new Date(row.tanggal_diberikan);
                            const tanggalDeadline = new Date(row.tanggal_deadline);
                            const hariDiberikan = Hari(tanggalDiberikan.getDay());
                            const hariDeadline = Hari(tanggalDeadline.getDay());
                            const formatDiberikan = tanggalDiberikan.toLocaleDateString('id-ID').split('/').join('-');
                            const formatDeadline = tanggalDeadline.toLocaleDateString('id-ID').split('/').join('-');
                            htmlSelesai += `<tr id='data' kode='${row.id_tugas}'>`;
                            htmlSelesai += `<td>${index + 1}</td>`;
                            htmlSelesai += `<td>${row.nama_kelas}</td>`;
                            htmlSelesai += `<td>${row.judul_tugas}</td>`;
                            htmlSelesai += `<td>${row.nama_mp}</td>`;
                            htmlSelesai += `<td><label class='label bg-success' style="border-radius: 6px; width: 200px; text-align: center;" id="tanggalMulai"> ${hariDiberikan}, ${formatDiberikan}</label>
                               </td>`;
                            htmlSelesai += `<td> <label class='label bg-danger' style="border-radius: 6px; width: 200px; text-align: center;" id="tanggalMulai">${hariDeadline}, ${formatDeadline} ${row.waktu_deadline.slice(0, 5)}</label></td>`;
                            htmlSelesai += `<td>
                                <button class='btn btn-warning' id='btn-edit' data-id='${row.id_tugas}'>Edit</button>
                                <button class='btn btn-danger btn-hapus' data-tugas = '${row.id_tugas}'>Hapus</button>
                                <a href='/guru/tugas_detail/${row.id_tugas}' class='btn btn-primary'>Detail</a>
                                </td>`;
                            htmlSelesai += "</tr>";
                        });
                        htmlSelesai += "</tbody></table>";
                    }else{
                        htmlSelesai = "<p>No data available with status 'aktif'</p>";
                    }

                    } else {
                        htmlAktif = "<p>No data available</p>";
                        htmlSelesai = "<p>No data available</p>";
                    }
                    $(".aktif").html(htmlAktif);
                    $(".selesai").html(htmlSelesai);
                },
                error: function(xhr, status, error) {
                    console.error("AJAX Error:", status, error);
                    $(".aktif").html("<p>Error loading data</p>");
                }
            });
        }

        // Form submission untuk tambah/edit data
        $("#tugasForm").on("submit", function(e) {
            e.preventDefault();
            const url = '/guru/input_tugas';
            let formData = new FormData(this);

            $.ajax({
                url: url,
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function(response) {
                    $("#modal-tambah").modal("hide");
                    Swal.fire({
                        title: "Berhasil!",
                        text: response.message,
                        icon: "success",
                        timer: 2000,
                        showConfirmButton: false,
                    }).then(() => {
                        list(); // Reload data setelah update
                    });
                },
                error: function(xhr) {
                    Swal.fire({
                        title: "Error!",
                        text: xhr.responseJSON.message,
                        icon: "error",
                        timer: 2000,
                        showConfirmButton: false,
                    });
                }
            });
        });
        $(document).on('click', '.btn-hapus', function () {
    const id_tugas = $(this).data("tugas"); // Ambil ID tugas dari atribut data
    // Konfirmasi dengan SweetAlert
    Swal.fire({
        title: 'Apakah Anda yakin?',
        text: "Anda tidak akan dapat mengembalikan data ini!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Ya, hapus!',
        cancelButtonText: 'Batal',
    }).then((result) => {
        if (result.isConfirmed) {
            // AJAX untuk menghapus data
            $.ajax({
                url: `/guru/hapusTugas/${id_tugas}`, // Endpoint untuk penghapusan
                type: 'POST',
                success: function (response) {
                    Swal.fire({
                        title: 'Berhasil!',
                        text: 'Berhasil menghapus tugas',
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false,
                    }).then(() => {
                        list(); // Refresh daftar tugas setelah penghapusan
                    });
                },
                error: function (xhr) {
                    Swal.fire({
                        title: 'Gagal!',
                        text: 'Gagal menghapus tugas',
                        icon: 'error',
                        timer: 2000,
                        showConfirmButton: false,
                    });
                },
            });
        }
    });
});

        // Menampilkan data untuk diedit di modal
        $(document).on('click', '#btn-edit', function() {
            const id = $(this).data("id");
            if(id){
                $.ajax({
                    url: `/guru/tugasByid/${id}`,
                    type: 'GET',
                    success: function(response) {
                        const row = response.data;
                        const tglDiberikan = new Date(row.tanggal_diberikan).toLocaleDateString('en-CA');
                        const tglDeadline = new Date(row.tanggal_deadline).toLocaleDateString('en-CA');

                        $("[name='id_tugas']").val(row.id_tugas);
                        $("[name='judul_tugas']").val(row.judul_tugas);
                        $("[name='tanggal_diberikan']").val(tglDiberikan);
                        $("[name='tanggal_deadline']").val(tglDeadline);
                        $("[name='deskripsi']").val(row.deskripsi);
                        $("[name='waktu_deadline']").val(row.waktu_deadline);
                        $("[name='id_kelas']").val(row.id_kelas); // Set selected class
                        
                        $("#modal-tambah").modal("show");
                    },
                    error: function(xhr) {
                        console.error("Error loading task data:", xhr.responseJSON.message);
                    }
                });
            }
        });
    });
   
</script>

<!-- Kode lainnya tetap sama -->

<%- include("../componen/footer") %>
