<%- include("./Componen/header") %>
<title>Guru | Data siswa</title>
<%- include("./Componen/sidebar") %>

<div class="content-wrapper">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h4>Data Siswa</h4>
            </div>
        </div>
    </div>
    <section class="content">
        <div class="container-fluid">
            <div class="row" style="display: none;" id="filter">
                <div class="col-12">
                  <div class="card">
                    <div class="card-body">
                      <div class="row">
                        <div class="col-md-6">
                          <div class="form-group">
                            <select class="form-control" id="kelasSelect">
                              <option value="semua">Pilih Kelas</option>
                              <option value="semua">Semua</option>
                              <% datakelas.forEach(k => { %>
                                <option value="<%= k.id_kelas %>"><%= k.nama_kelas %></option>
                              <% }); %>
                            </select>
                          </div>
                          <div class="form-group">
                            <select class="form-control" id="genderSelect">
                              <option value="semua">Pilih Gender</option>
                              <option value="semua">Semua</option>
                              <option value="laki-laki">Laki-laki</option>
                              <option value="perempuan">Perempuan</option>
                            </select>
                          </div>
                          <div class="form-group">
                            <input type="text" class="form-control" id="siswaSelect" placeholder="Nama Siswa">
                          </div>
                          <div class="form-group">
                            <input type="text" class="form-control" id="waliSelect" placeholder="Nama Wali">
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="form-group mb-3">
                            <select class="form-control" id="tahunSelect">
                              <option value="">Pilih Tahun Ajar</option>
                              <option value="semua">Semua</option>
                              <% dataTahun.forEach(t => { %>
                                <option value="<%= t.idth %>"><%= t.nama_ajaran %></option>
                              <% }); %>
                            </select>
                          </div>
                          <div class="form-group mb-3">
                            <input type="date" class="form-control" id="dateSelect">
                          </div>
                          <div class="form-group">
                            <input type="text" class="form-control" id="alamatSelect" placeholder="Alamat">
                          </div>
                          <div class="form-group">
                            <input type="text" class="form-control" id="pekerjaanSelect" placeholder="Pekerjaan Wali">
                          </div>
                        </div>
                        <button id="filterButton" class="btn btn-secondary ml-2" style="height: 35px;">Search</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex flex-column flex-md-row justify-content-between mb-2">
                
                                <div class="d-flex justify-content-end">
                            <a href="#" class="btn btn-warning mr-2" id="filter-btn">Filter</a>

                                    <button type="submit" class="btn btn-secondary mr-2">Search</button>
                                  <input type="text" class="form-control" name="table_search" style="width: 160px;">
                                </div>
                              </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <div class="body">
                                    <!-- Konten tabel akan dimuat di sini -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>
<div class="modal fade" id="modal-siswa">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Informasi Siswa</h4>
                <button type="button" id="modal-close-btn" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                
            </div>
            <div class="modal-body">
                <div class="main-body">
                    <div class="row gutters-sm">
                        <div class="col-md-4 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex flex-column align-items-center text-center">
                                      <img src="" id="fotoFp" alt="Admin" class="rounded-circle" style="width: 150px; height: 170px; object-fit: cover;">

                                        <div class="mt-3">
                                            <h4 id="nama"></h4>
                                            <p class="text-secondary mb-1" id="kelas"></p>
                                            <p class="text-muted font-size-sm" id="alamat"></p>
                                            <button class="btn btn-primary">Follow</button>
                                            
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <h6 class="mb-0">Nis</h6>
                                                </div>
                                                <div class="col-md-8 text-secondary" id="modal-nis">
                                                  
                                                </div>
                                            </div>
                                            <hr>
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <h6 class="mb-0">Nama</h6>
                                                </div>
                                                <div class="col-md-8 text-secondary" id="modal-nama">
                                                    
                                                </div>
                                            </div>
                                            <hr>
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <h6 class="mb-0">Kelas</h6>
                                                </div>
                                                <div class="col-md-8 text-secondary" id="modal-kelas">
                                                    
                                                </div>
                                            </div>
                                            <hr>
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <h6 class="mb-0">Tahun Ajaran</h6>
                                                </div>
                                                <div class="col-md-8 text-secondary" id="modal-ajaran">
                                                    
                                                </div>
                                            </div>
                                            <hr>
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <h6 class="mb-0">Nama Wali</h6>
                                                </div>
                                                <div class="col-md-8 text-secondary" id="modal-wali">
                                                    
                                                </div>
                                            </div>
                                            <hr>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <h6 class="mb-0">Tlp</h6>
                                                </div>
                                                <div class="col-md-8 text-secondary" id="modal-tlp">
                                                    
                                                </div>
                                            </div>
                                            <hr>
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <h6 class="mb-0">Address</h6>
                                                </div>
                                                <div class="col-md-8 text-secondary" id="modal-alamat">
                                                   
                                                </div>
                                            </div>
                                            <hr>
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <h6 class="mb-0">Gender</h6>
                                                </div>
                                                <div class="col-md-8 text-secondary" id="modal-jk">
                                                   
                                                </div>
                                            </div>
                                            <hr>
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <h6 class="mb-0">Pekerjaan Wali</h6>
                                                </div>
                                                <div class="col-md-8 text-secondary" id="modal-pekerjaan">
                                                   
                                                </div>
                                            </div>
                                            <hr>
                                            
                                        </div>
                                    </div>
                                    <hr>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- /.modal-body -->
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>

<!-- Skrip dari AdminLTE dan Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
<script src="/plugins/jquery/jquery.min.js"></script>
<script src="/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="/dist/js/adminlte.min.js"></script>

<script>
    $(document).ready(function() {
        list();
        $("#filter-btn").click(function() {
      
      $("#filter").slideToggle();

      
    });
    $("#filterButton").on("click", function() {
    const tahunSelected = $("#tahunSelect").val();
    const selectedKelas = $("#kelasSelect").val();
    const genderSelect = $("#genderSelect").val();
    const dateSelect = $("#dateSelect").val();
    const siswaSelect = $("#siswaSelect").val();
    const alamatSelect = $("#alamatSelect").val();
    const waliSelect = $("#waliSelect").val();
    const pekerjaanSelect = $("#pekerjaanSelect").val();

    const params = {};

    // Tambahkan parameter filter jika ada
    if (tahunSelected && tahunSelected !== "semua") {
        params["idth"] = tahunSelected;
    }
    if (selectedKelas && selectedKelas !== "semua") {
        params["id_kelas"] = selectedKelas;
    }
    if (genderSelect && genderSelect !== "semua") {
        params["jk"] = genderSelect;
    }
    if (dateSelect) {
        params["tgl_lahir"] = dateSelect;
    }
    if (siswaSelect) {
        params["nama_siswa"] = siswaSelect;
    }
    if (alamatSelect) {
        params["alamat"] = alamatSelect;
    }
    if (waliSelect) {
        params["nama_wali"] = waliSelect;
    }
    if (pekerjaanSelect) {
        params["pekerjaan_wali"] = pekerjaanSelect;
    }

    // Panggil fungsi list dengan parameter filter
    list(params);
});

    });
//list
    function list(params = {}) {
        let html = "";
        $.ajax({
            url: "/guru/list_siswa",
            type: "GET",
            data: params,
            success: function(result) {
                const val = result.data;
                if (val.length > 0) {
                    html += "<table class='table table-bordered table-striped table-hover'>";
                    html += "<thead class='bg-dark'>";
                    html += "<tr>"
                    html += "<th style='width: 1%;'>No</th>";
                    html += "<th>Nis</th>";
                    html += "<th>Foto</th>";
                    html += "<th>Nama Siswa</th>";
                    html += "<th>Kelas</th>";
                    html += "<th>Gender</th>";
                    html += "<th>Tahun Ajaran</th>";
                    html += "<th>Action</th>";
                    html += "</tr>";
                    html += "</thead><tbody>";
                    $.each(val, function(index, row) {
                        const foto = row.foto.length > 0 ? `/images/${row.foto}` : '/images/icon.png' 
                        html += `<tr>`;
                        html += `<td>${index + 1}</td>`;
                        html += `<td>${row.nis}</td>`;
                        html += `<td><img style="width: 100px; height: 110px; object-fit: cover;" src="${foto}" class="img-thumbnail" alt=""></td></td>`;
                        html += `<td>${row.nama_siswa}</td>`;
                        html += `<td>${row.nama_kelas}</td>`;
                        html += `<td>${row.jk}</td>`;
                        html += `<td>${row.nama_ajaran}</td>`;
                        html += `<td><a href="#" class="btn btn-primary info-btn" data-nis="${row.nis}"><i class="fa fa-info-circle"></i></a></td>`
                        html += "</tr>";
                    });
                    html += "</tbody></table>";
                } else {
                    html = "<p>No data available</p>";
                }
                $(".body").html(html);
            },
            error: function(xhr, status, error) {
                console.error("AJAX Error:", status, error);
                $(".body").html("<p>Error loading data</p>");
            }
        });
    }
    $(document).on('click', '.info-btn', function() {
      var nis = $(this).data("nis");
      
      $.ajax({
        url: `/admin/info_siswa/${nis}`, // Pastikan URL sesuai
        method: 'GET',
        success: function(response) {
          if (response.siswa) { // Pastikan data siswa ada
            var data = response.siswa; // Ambil data siswa
            $('#modal-nis').text(data.nis); // Tampilkan NIS
            $('#modal-nama').text(data.nama_siswa); // Tampilkan nama siswa
            $('#modal-ajaran').text(data.nama_ajaran); // Tampilkan nama siswa
            $('#nama').text(data.nama_siswa); // Tampilkan nama siswa
            $('#modal-kelas').text(data.nama_kelas); // Tampilkan kelas siswa, pastikan ini ada dalam data
            $('#kelas').text(data.nama_kelas); // Tampilkan kelas siswa, pastikan ini ada dalam data
            $('#modal-jk').text(data.jk); // Tampilkan kelas siswa, pastikan ini ada dalam data
            $('#modal-alamat').text(data.alamat); // Tampilkan kelas siswa, pastikan ini ada dalam data
            $('#alamat').text(data.alamat); // Tampilkan kelas siswa, pastikan ini ada dalam data
            $('#modal-wali').text(data.nama_wali); // Tampilkan kelas siswa, pastikan ini ada dalam data
            $('#modal-pekerjaan').text(data.pekerjaan_wali); // Tampilkan kelas siswa, pastikan ini ada dalam data
            $('#modal-tlp').text("(+62) " + data.tlp); // Tampilkan kelas siswa, pastikan ini ada dalam data
            if (data.foto) {
          $('#fotoFp').attr('src', `/images/${data.foto}`);
        } else {
          $('#fotoFp').attr('src', '/icon.png'); // Jika foto tidak ada
        }
            $("#modal-siswa").modal("show"); // Tampilkan modal
          } else {
            alert('Data tidak ditemukan'); // Jika tidak ada data
          }
        },
        error: function() {
          alert('Terjadi kesalahan saat mengambil data.'); // Tangani kesalahan
        }
      });
    });
    $("#modal-close-btn").click(function () {
    $('#modal-siswa').modal('hide');
});

</script>
<%- include("./Componen/footer") %>

